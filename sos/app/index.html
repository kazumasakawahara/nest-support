<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#dc2626">
    <title>nest SOS</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            padding: 20px 15px;
            text-align: center;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 20px;
            color: #374151;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .user-name {
            font-size: 28px;
            font-weight: bold;
            color: #dc2626;
            margin-top: 8px;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ */
        .main {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        /* SOSãƒœã‚¿ãƒ³ */
        .sos-button {
            width: 280px;
            height: 280px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(145deg, #ef4444, #dc2626);
            box-shadow:
                0 10px 40px rgba(220, 38, 38, 0.5),
                inset 0 -5px 20px rgba(0,0,0,0.2),
                inset 0 5px 20px rgba(255,255,255,0.2);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s, box-shadow 0.1s;
            -webkit-tap-highlight-color: transparent;
            animation: pulse 2s infinite;
        }

        .sos-button:active {
            transform: scale(0.95);
            box-shadow:
                0 5px 20px rgba(220, 38, 38, 0.5),
                inset 0 -2px 10px rgba(0,0,0,0.2),
                inset 0 2px 10px rgba(255,255,255,0.2);
            animation: none;
        }

        .sos-button:disabled {
            opacity: 0.7;
            animation: none;
        }

        .sos-button .icon {
            font-size: 60px;
            margin-bottom: 10px;
        }

        .sos-button .text {
            font-size: 72px;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            letter-spacing: 8px;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.03);
            }
        }

        /* ãƒ•ãƒƒã‚¿ãƒ¼ */
        .footer {
            padding: 20px;
            text-align: center;
            background: white;
            font-size: 16px;
            color: #6b7280;
        }

        /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å…±é€š */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 100;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .overlay.show {
            display: flex;
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        .loading-spinner {
            width: 80px;
            height: 80px;
            border: 6px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            color: white;
            font-size: 24px;
            margin-top: 30px;
            text-align: center;
            padding: 0 30px;
            line-height: 1.5;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* æˆåŠŸç”»é¢ */
        .success-icon {
            font-size: 100px;
            margin-bottom: 20px;
        }

        .success-text {
            color: white;
            font-size: 28px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
        }

        .success-subtext {
            color: rgba(255,255,255,0.8);
            font-size: 18px;
            text-align: center;
            margin-bottom: 40px;
        }

        .close-button {
            padding: 20px 60px;
            font-size: 20px;
            background: white;
            color: #374151;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
        }

        /* ã‚¨ãƒ©ãƒ¼ç”»é¢ */
        .error-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .error-text {
            color: white;
            font-size: 20px;
            text-align: center;
            padding: 0 30px;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .retry-button {
            padding: 18px 50px;
            font-size: 18px;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .cancel-button {
            padding: 15px 40px;
            font-size: 16px;
            background: transparent;
            color: white;
            border: 2px solid white;
            border-radius: 12px;
            cursor: pointer;
        }

        /* è¨­å®šã‚¨ãƒ©ãƒ¼ */
        .setup-error {
            display: none;
            text-align: center;
            padding: 40px 20px;
        }

        .setup-error.show {
            display: block;
        }

        .setup-error h2 {
            color: #dc2626;
            margin-bottom: 20px;
        }

        .setup-error p {
            color: #6b7280;
            line-height: 1.8;
        }
    </style>
</head>
<body>
    <!-- é€šå¸¸ç”»é¢ -->
    <div id="mainContent">
        <div class="header">
            <h1>ğŸ  nest SOS</h1>
            <div class="user-name" id="userName">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>

        <div class="main">
            <button class="sos-button" id="sosButton" onclick="sendSOS()">
                <span class="icon">ğŸ†˜</span>
                <span class="text">SOS</span>
            </button>
        </div>

        <div class="footer">
            ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨åŠ©ã‘ã‚’å‘¼ã¹ã¾ã™
        </div>
    </div>

    <!-- è¨­å®šã‚¨ãƒ©ãƒ¼ç”»é¢ -->
    <div class="setup-error" id="setupError">
        <h2>âš ï¸ è¨­å®šãŒå¿…è¦ã§ã™</h2>
        <p>
            ã“ã®ã‚¢ãƒ—ãƒªã‚’ä½¿ã†ã«ã¯ã€<br>
            å°‚ç”¨ã®URLãŒå¿…è¦ã§ã™ã€‚<br><br>
            æ”¯æ´è€…ã®æ–¹ã«<br>
            QRã‚³ãƒ¼ãƒ‰ã‚’ã‚‚ã‚‰ã£ã¦ãã ã•ã„ã€‚
        </p>
    </div>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div class="overlay" id="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">é€ä¿¡ä¸­...</div>
    </div>

    <!-- æˆåŠŸç”»é¢ -->
    <div class="overlay" id="success">
        <div class="success-icon">âœ…</div>
        <div class="success-text">é€ä¿¡ã—ã¾ã—ãŸï¼</div>
        <div class="success-subtext">åŠ©ã‘ãŒæ¥ã‚‹ã¾ã§å¾…ã£ã¦ã„ã¦ã­</div>
        <button class="close-button" onclick="closeSuccess()">ã¨ã˜ã‚‹</button>
    </div>

    <!-- ã‚¨ãƒ©ãƒ¼ç”»é¢ -->
    <div class="overlay" id="error">
        <div class="error-icon">ğŸ˜¢</div>
        <div class="error-text" id="errorText">é€ä¿¡ã§ãã¾ã›ã‚“ã§ã—ãŸ</div>
        <button class="retry-button" onclick="sendSOS()">ã‚‚ã†ä¸€åº¦é€ã‚‹</button>
        <button class="cancel-button" onclick="closeError()">ã¨ã˜ã‚‹</button>
    </div>

    <script>
        // --- è¨­å®š ---
        // APIã‚µãƒ¼ãƒãƒ¼ã®URLï¼ˆå›£ä½“ã®PCã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«å¤‰æ›´ï¼‰
        const API_BASE_URL = getApiBaseUrl();

        function getApiBaseUrl() {
            // åŒã˜ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã‚¢ãƒ—ãƒªã‚’é…ä¿¡ã—ã¦ã„ã‚‹å ´åˆ
            const protocol = window.location.protocol;
            const host = window.location.host;
            return `${protocol}//${host}`;
        }

        // --- åˆæœŸåŒ– ---
        const params = new URLSearchParams(window.location.search);
        const clientId = params.get('id') || params.get('name') || '';

        // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDãŒãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        if (!clientId) {
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('setupError').classList.add('show');
        } else {
            // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæƒ…å ±ã‚’å–å¾—ã—ã¦åå‰ã‚’è¡¨ç¤º
            initializeApp();
        }

        async function initializeApp() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/client/${encodeURIComponent(clientId)}`);
                const data = await response.json();

                if (data.found && data.name) {
                    document.getElementById('userName').textContent = data.name + ' ã•ã‚“';
                } else {
                    document.getElementById('userName').textContent = clientId + ' ã•ã‚“';
                }
            } catch (e) {
                // APIã«æ¥ç¶šã§ããªã„å ´åˆã¯URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®åå‰ã‚’ä½¿ç”¨
                document.getElementById('userName').textContent = clientId + ' ã•ã‚“';
                console.log('APIæ¥ç¶šã‚¨ãƒ©ãƒ¼:', e);
            }
        }

        // --- SOSé€ä¿¡ ---
        let isSending = false;

        async function sendSOS() {
            if (isSending) return;
            isSending = true;

            const loading = document.getElementById('loading');
            const loadingText = document.getElementById('loadingText');

            loading.classList.add('show');
            loadingText.textContent = 'ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­...';

            // ä½ç½®æƒ…å ±ã‚’å–å¾—
            let location = null;
            try {
                location = await getLocation();
                loadingText.textContent = 'é€ä¿¡ä¸­...';
            } catch (e) {
                console.log('ä½ç½®æƒ…å ±å–å¾—å¤±æ•—:', e);
                loadingText.textContent = 'é€ä¿¡ä¸­...';
            }

            // APIã«SOSé€ä¿¡
            try {
                const response = await fetch(`${API_BASE_URL}/api/sos`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        client_id: clientId,
                        latitude: location?.latitude || null,
                        longitude: location?.longitude || null,
                        accuracy: location?.accuracy || null
                    })
                });

                loading.classList.remove('show');

                if (response.ok) {
                    showSuccess();
                } else {
                    const error = await response.json();
                    showError(error.detail || 'é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (e) {
                loading.classList.remove('show');
                showError('ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“\nWi-Fiã‚’ç¢ºèªã—ã¦ãã ã•ã„');
                console.error('SOSé€ä¿¡ã‚¨ãƒ©ãƒ¼:', e);
            }

            isSending = false;
        }

        // ä½ç½®æƒ…å ±å–å¾—
        function getLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation not supported'));
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        });
                    },
                    (error) => {
                        reject(error);
                    },
                    {
                        enableHighAccuracy: false,
                        timeout: 10000,
                        maximumAge: 300000
                    }
                );
            });
        }

        // æˆåŠŸç”»é¢è¡¨ç¤º
        function showSuccess() {
            document.getElementById('success').classList.add('show');
            // ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå¯¾å¿œã—ã¦ã„ã‚‹å ´åˆï¼‰
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200]);
            }
        }

        function closeSuccess() {
            document.getElementById('success').classList.remove('show');
        }

        // ã‚¨ãƒ©ãƒ¼ç”»é¢è¡¨ç¤º
        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('error').classList.add('show');
        }

        function closeError() {
            document.getElementById('error').classList.remove('show');
        }

        // --- Service Workerï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œï¼‰ ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(function(err) {
                console.log('ServiceWorker registration failed:', err);
            });
        }
    </script>
</body>
</html>
